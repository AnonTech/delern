# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#

lane :ensure_clean_git do
  ensure_git_status_clean(show_diff: true)
end

lane :update_analysis_options do
  # TODO(dotdoom): move into fastlane-flutter plugin.
  fastlane_require 'yaml'
  fastlane_require 'open-uri'

  local_file = '../flutter/analysis_options.yaml'

  all_rules = YAML.load(open(
    'https://raw.githubusercontent.com/dart-lang/linter/' +
    'master/example/all.yaml').read)['linter']['rules'].sort
  existing_rules = YAML.load_file(local_file)['linter']['rules']

  if (all_rules - existing_rules.keys).any?
    enabled_rules = (all_rules - existing_rules.reject { |k, v| v }.keys).sort
    open(local_file, 'r+') do |f|
      break if f.eof? while f.gets.strip != '# AUTOGENERATED CONTENT UNTIL EOF'
      f.truncate(f.pos)
      enabled_rules.each do |rule|
        f.puts "    #{rule}: true"
      end
    end
  end
end

desc 'Update all dependencies in lockfiles (bundler, npm, Flutter)'
lane :update do
  update_analysis_options
  Dir.chdir('..') do
    sh %w(bundle update)
    Dir.chdir('flutter') do
      sh %w(flutter upgrade)
      sh %w(flutter packages upgrade)
      if RUBY_PLATFORM.include? 'darwin'
        Dir.chdir('ios') { sh %w(bundle exec pod update) }
      end
    end
    Dir.chdir('firebase') do
      sh %w(npm update)
      Dir.chdir('functions') do
        sh %w(npm update)
      end
    end
  end
end

# vim: ft=ruby
